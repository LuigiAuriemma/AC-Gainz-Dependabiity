


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CarrelloServlet</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">controller.homepage</a>
</div>

<h1>Coverage Summary for Class: CarrelloServlet (controller.homepage)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CarrelloServlet</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    75,7%
  </span>
  <span class="absValue">
    (53/70)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98,5%
  </span>
  <span class="absValue">
    (128/130)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package controller.homepage;
&nbsp;
&nbsp;import jakarta.servlet.ServletException;
&nbsp;import jakarta.servlet.annotation.WebServlet;
&nbsp;import jakarta.servlet.http.HttpServlet;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import jakarta.servlet.http.HttpServletResponse;
&nbsp;import jakarta.servlet.http.HttpSession;
&nbsp;import model.*;
&nbsp;import org.json.simple.JSONArray;
&nbsp;import org.json.simple.JSONObject;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.PrintWriter;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;@WebServlet(value = &quot;/cartServlet&quot;)
<b class="fc">&nbsp;public class CarrelloServlet extends HttpServlet {</b>
&nbsp;    @Override
&nbsp;    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<b class="fc">&nbsp;        String action = req.getParameter(&quot;action&quot;);</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;        ProdottoDAO prodottoDAO = new ProdottoDAO();</b>
<b class="fc">&nbsp;        HttpSession session = req.getSession();</b>
<b class="fc">&nbsp;        synchronized (session) { //uso di synchronized per race conditions su session tramite ajax</b>
<b class="fc">&nbsp;            resp.setContentType(&quot;application/json&quot;);</b>
<b class="fc">&nbsp;            PrintWriter out = resp.getWriter();</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;            switch (action) {</b>
<b class="fc">&nbsp;                case &quot;show&quot; -&gt; handleShowAction(session, prodottoDAO, out);</b>
<b class="fc">&nbsp;                case &quot;addVariant&quot; -&gt; handleAddVariantAction(req, session, prodottoDAO, out);</b>
<b class="fc">&nbsp;                case &quot;removeVariant&quot; -&gt; handleRemoveVariantAction(req, session, prodottoDAO, out);</b>
<b class="fc">&nbsp;                case &quot;quantityVariant&quot; -&gt; handleQuantityVariantAction(req, session, prodottoDAO, out);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    //metodo che permette di visualizzare i prodotti all&#39;interno del carrello
&nbsp;    private void handleShowAction(HttpSession session, ProdottoDAO prodottoDAO, PrintWriter out) throws IOException {
<b class="fc">&nbsp;        List&lt;Carrello&gt; cartItems = (List&lt;Carrello&gt;) session.getAttribute(&quot;cart&quot;);</b>
&nbsp;
<b class="fc">&nbsp;        if (cartItems != null &amp;&amp; !cartItems.isEmpty()) {</b>
<b class="fc">&nbsp;            writeCartItemsToResponse(cartItems, prodottoDAO, out);</b>
&nbsp;        } else {
<b class="fc">&nbsp;            JSONArray jsonArray = new JSONArray();</b>
<b class="fc">&nbsp;            out.println(jsonArray);</b>
<b class="fc">&nbsp;            out.flush();</b>
&nbsp;            out.close();
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    //metodo che viene usato quando viene modificata la quantita di un prodotto nel carrello
&nbsp;    public void handleQuantityVariantAction(HttpServletRequest request,  HttpSession session, ProdottoDAO prodottoDAO, PrintWriter out) throws IOException {
&nbsp;        //prende i dati del prodotto nel carrello dalla request
<b class="fc">&nbsp;        String idProdotto = request.getParameter(&quot;id&quot;);</b>
<b class="fc">&nbsp;        String gusto = request.getParameter(&quot;gusto&quot;);</b>
&nbsp;
&nbsp;        int pesoConfezione;
&nbsp;        try {
<b class="fc">&nbsp;            pesoConfezione = Integer.parseInt(request.getParameter(&quot;pesoConfezione&quot;));</b>
&nbsp;        } catch (NumberFormatException e) {
&nbsp;            // Parametro non valido, interrompi l&#39;azione in modo sicuro
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Prodotto p = prodottoDAO.doRetrieveById(idProdotto);</b>
<b class="pc">&nbsp;        if (p != null){</b>
<b class="fc">&nbsp;            VarianteDAO varianteDAO = new VarianteDAO();</b>
&nbsp;
&nbsp;            // 1. Salva la lista restituita dal DAO
<b class="fc">&nbsp;            List&lt;Variante&gt; varianti = varianteDAO.doRetrieveVariantByFlavourAndWeight(p.getIdProdotto(), gusto, pesoConfezione);</b>
&nbsp;
&nbsp;            // 2. Controlla se la lista è vuota PRIMA di accedere a .get(0)
<b class="pc">&nbsp;            if (varianti.isEmpty()) {</b>
&nbsp;                // La variante non esiste, gestisci l&#39;errore.
&nbsp;                return;
&nbsp;            }
&nbsp;            // 3. Solo ora puoi prendere la variante in sicurezza
<b class="fc">&nbsp;            Variante v = varianti.get(0);</b>
&nbsp;
<b class="fc">&nbsp;            List&lt;Carrello&gt; cartItems = (List&lt;Carrello&gt;) session.getAttribute(&quot;cart&quot;);</b>
<b class="pc">&nbsp;            if (v != null &amp;&amp; cartItems != null){</b>
<b class="fc">&nbsp;                String quantityStr = request.getParameter(&quot;quantity&quot;);</b>
&nbsp;
<b class="pc">&nbsp;                if (quantityStr != null &amp;&amp; !quantityStr.isBlank()) {</b>
&nbsp;
&nbsp;                    int q; // Variabile int sicura
&nbsp;                    try {
&nbsp;                        // Prova a parsare la stringa
<b class="fc">&nbsp;                        q = Integer.parseInt(quantityStr);</b>
&nbsp;                    } catch (NumberFormatException e) {
&nbsp;                        // Se fallisce (es. &quot;abc&quot;), interrompi l&#39;azione
&nbsp;                        return;
&nbsp;                    }
&nbsp;
<b class="fc">&nbsp;                    if (q &lt;= v.getQuantita()){</b>
&nbsp;
&nbsp;                        // Se la quantità è 0 o meno, considera l&#39;azione come una rimozione
<b class="fc">&nbsp;                        if (q &lt;= 0) {</b>
<b class="fc">&nbsp;                            handleRemoveVariantAction(request, session, prodottoDAO, out);</b>
&nbsp;                        }
&nbsp;                        else {
&nbsp;                            //aggiorna il prezzo in base alla nuova quantità contando ovviamente lo sconto
<b class="fc">&nbsp;                            float price = v.getPrezzo();</b>
<b class="pc">&nbsp;                            if (v.getSconto() &gt; 0){</b>
<b class="nc">&nbsp;                                price = price * (1 - (float) v.getSconto() / 100);</b>
<b class="nc">&nbsp;                                price = Math.round(price * 100.0f) / 100.0f;</b>
&nbsp;                            }
&nbsp;
<b class="fc">&nbsp;                            price *= q;</b>
&nbsp;
&nbsp;                            //aggiorna il prodotto nel carrello con la nuova quantita e il nuovo prezzo
<b class="pc">&nbsp;                            for (Carrello c: cartItems){</b>
<b class="pc">&nbsp;                                if (c.getIdVariante() == v.getIdVariante()){</b>
<b class="fc">&nbsp;                                    c.setQuantita(q);</b>
<b class="fc">&nbsp;                                    c.setPrezzo(price);</b>
&nbsp;                                    break;
&nbsp;                                }
&nbsp;                            }
&nbsp;
<b class="fc">&nbsp;                            session.setAttribute(&quot;cart&quot;, cartItems);</b>
<b class="fc">&nbsp;                            writeCartItemsToResponse(cartItems, prodottoDAO, out);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                    // else: la quantità richiesta è maggiore dello stock disponibile.
&nbsp;                    // Non facciamo nulla in modo sicuro (non aggiorniamo il carrello).
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    //metodo che viene usato per rimuovere un prodotto dal carrello
&nbsp;    public void handleRemoveVariantAction(HttpServletRequest request, HttpSession session, ProdottoDAO prodottoDAO, PrintWriter out) throws IOException {
&nbsp;        //prendo i dati del prodotto nel carrello passati dalla request
<b class="fc">&nbsp;        String idToRemove = request.getParameter(&quot;id&quot;);</b>
<b class="fc">&nbsp;        String gusto = request.getParameter(&quot;gusto&quot;);</b>
&nbsp;        int pesoConfezione;
&nbsp;        try {
<b class="fc">&nbsp;            pesoConfezione = Integer.parseInt(request.getParameter(&quot;pesoConfezione&quot;));</b>
&nbsp;        } catch (NumberFormatException e) {
&nbsp;            // Parametro non valido, interrompi l&#39;azione
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        Prodotto p = prodottoDAO.doRetrieveById(idToRemove);</b>
&nbsp;
<b class="pc">&nbsp;        if (p != null){</b>
<b class="fc">&nbsp;            VarianteDAO varianteDAO = new VarianteDAO();</b>
&nbsp;
&nbsp;            // 1. Salva la lista restituita dal DAO
<b class="fc">&nbsp;            List&lt;Variante&gt; varianti = varianteDAO.doRetrieveVariantByFlavourAndWeight(p.getIdProdotto(), gusto, pesoConfezione);</b>
&nbsp;
&nbsp;            // 2. Controlla se la lista è vuota PRIMA di accedere a .get(0)
<b class="fc">&nbsp;            if (varianti.isEmpty()) {</b>
&nbsp;                // La variante non esiste, gestisci l&#39;errore.
&nbsp;                // L&#39;opzione più sicura è interrompere l&#39;esecuzione di questo metodo.
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // 3. Solo ora puoi prendere la variante in sicurezza
<b class="fc">&nbsp;            Variante v = varianti.get(0);</b>
<b class="pc">&nbsp;            if (v != null){</b>
<b class="fc">&nbsp;                List&lt;Carrello&gt; cartItems = (List&lt;Carrello&gt;) session.getAttribute(&quot;cart&quot;);</b>
&nbsp;
&nbsp;                //elimina il prodotto dal carrello
<b class="pc">&nbsp;                if (cartItems != null) {</b>
<b class="fc">&nbsp;                    cartItems.removeIf(item -&gt; item.getIdVariante()  == v.getIdVariante());</b>
<b class="fc">&nbsp;                    session.setAttribute(&quot;cart&quot;, cartItems);</b>
&nbsp;
<b class="fc">&nbsp;                    writeCartItemsToResponse(cartItems, prodottoDAO, out);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    //metodo che aggiunge al carrello un nuovo prodotto
&nbsp;    private void handleAddVariantAction(HttpServletRequest request, HttpSession session, ProdottoDAO prodottoDAO, PrintWriter out) throws IOException {
&nbsp;        //prendo il prodotto
<b class="fc">&nbsp;        String id = request.getParameter(&quot;id&quot;);</b>
<b class="fc">&nbsp;        Prodotto p = prodottoDAO.doRetrieveById(id);</b>
<b class="fc">&nbsp;        if (p != null) {</b>
<b class="fc">&nbsp;            int quantity = 1;</b>
&nbsp;
&nbsp;            //setto la quantita desiderata dall&#39;utente
<b class="pc">&nbsp;            if (request.getParameter(&quot;quantity&quot;) != null) {</b>
&nbsp;                try {
<b class="fc">&nbsp;                    int x = Integer.parseInt(request.getParameter(&quot;quantity&quot;));</b>
<b class="pc">&nbsp;                    if (x &gt; 0) quantity = x;</b>
&nbsp;                } catch (NumberFormatException e) {
&nbsp;                    // Se la quantità non è un numero, ignora l&#39;input
&nbsp;                    // e la quantità resta 1 (default). Non interrompiamo l&#39;azione.
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;
&nbsp;            //prendo altri dati relativi al prodotto
<b class="fc">&nbsp;            String gusto = request.getParameter(&quot;gusto&quot;);</b>
<b class="fc">&nbsp;            String pesoConfezioneStr = request.getParameter(&quot;pesoConfezione&quot;); // Prendiamo la stringa</b>
&nbsp;
&nbsp;            int pesoConfezione; // Variabile int sicura
&nbsp;            try {
<b class="fc">&nbsp;                pesoConfezione = Integer.parseInt(pesoConfezioneStr);</b>
&nbsp;            } catch (NumberFormatException e) {
&nbsp;                // Se il peso non è un numero, non possiamo trovare la variante.
&nbsp;                // Interrompiamo l&#39;azione in modo sicuro.
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;
<b class="fc">&nbsp;            VarianteDAO varianteDAO = new VarianteDAO();</b>
&nbsp;
&nbsp;            // Usiamo la variabile &#39;int&#39; sicura (pesoConfezione)
<b class="fc">&nbsp;            List&lt;Variante&gt; varianti = varianteDAO.doRetrieveVariantByFlavourAndWeight(p.getIdProdotto(), gusto, pesoConfezione);</b>
&nbsp;
&nbsp;            // (Questa è la correzione per la Faglia 1 che hai già fatto, ottimo!)
<b class="fc">&nbsp;            if (varianti.isEmpty()) {</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            Variante v = varianti.get(0);</b>
&nbsp;
<b class="fc">&nbsp;            List&lt;Carrello&gt; cartItems = (List&lt;Carrello&gt;) session.getAttribute(&quot;cart&quot;);</b>
<b class="fc">&nbsp;            if (cartItems == null) cartItems = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="pc">&nbsp;            if (v != null) {</b>
<b class="fc">&nbsp;                float price = v.getPrezzo();</b>
&nbsp;
<b class="fc">&nbsp;                if (v.getSconto() &gt; 0) {</b>
<b class="fc">&nbsp;                    price = price * (1 - (float) v.getSconto() / 100);</b>
<b class="fc">&nbsp;                    price = Math.round(price * 100.0f) / 100.0f;</b>
&nbsp;                }
&nbsp;
&nbsp;                //controllo che il prodotto da aggiungere non fosse gia presente nel carrello
&nbsp;                //nel caso lo fosse sommo le due quantita e aggiorno ovviamente il prezzo
<b class="fc">&nbsp;                boolean itemExists = false;</b>
<b class="fc">&nbsp;                if (!cartItems.isEmpty()) {</b>
<b class="pc">&nbsp;                    for (Carrello item : cartItems) {</b>
<b class="pc">&nbsp;                        if (item.getIdVariante() == v.getIdVariante()) {</b>
<b class="fc">&nbsp;                            int newQuantity = item.getQuantita() + quantity;</b>
<b class="fc">&nbsp;                            if (newQuantity &lt;= v.getQuantita()) {</b>
<b class="fc">&nbsp;                                item.setQuantita(newQuantity);</b>
<b class="fc">&nbsp;                                item.setPrezzo(item.getPrezzo() + (price * quantity));</b>
&nbsp;                            }
<b class="fc">&nbsp;                            itemExists = true;</b>
&nbsp;                            break;
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;                //se il prodotto non è presente nel carrello lo aggiungo
<b class="fc">&nbsp;                if (!itemExists &amp;&amp; quantity &lt;= v.getQuantita()) {</b>
<b class="fc">&nbsp;                    Carrello c = new Carrello();</b>
<b class="fc">&nbsp;                    c.setIdProdotto(id);</b>
<b class="fc">&nbsp;                    c.setIdVariante(v.getIdVariante());</b>
<b class="fc">&nbsp;                    c.setNomeProdotto(p.getNome());</b>
<b class="fc">&nbsp;                    c.setQuantita(quantity);</b>
<b class="fc">&nbsp;                    c.setPrezzo(price * quantity);</b>
<b class="fc">&nbsp;                    c.setGusto(gusto);</b>
<b class="fc">&nbsp;                    c.setPesoConfezione(pesoConfezione);</b>
<b class="fc">&nbsp;                    c.setImmagineProdotto(p.getImmagine());</b>
<b class="fc">&nbsp;                    cartItems.add(c);</b>
&nbsp;                }
&nbsp;
<b class="fc">&nbsp;                session.setAttribute(&quot;cart&quot;, cartItems);</b>
<b class="fc">&nbsp;                writeCartItemsToResponse(cartItems, prodottoDAO, out);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    //metodo che per ogni prodotto nel carrello crea un oggetto JSON e lo inserisce in un JSONArray
&nbsp;    //metodo che crea quindi il carrello effettivo
&nbsp;    private void writeCartItemsToResponse(List&lt;Carrello&gt; cartItems, ProdottoDAO prodottoDAO, PrintWriter out) throws IOException{
<b class="fc">&nbsp;        JSONArray jsonArray = new JSONArray();</b>
<b class="fc">&nbsp;        float totalPrice = 0;</b>
&nbsp;
<b class="fc">&nbsp;        for (Carrello item: cartItems){</b>
<b class="fc">&nbsp;            Prodotto p = prodottoDAO.doRetrieveById(item.getIdProdotto());</b>
&nbsp;
&nbsp;            // --- CORREZIONE FAGLIA ---
&nbsp;            // Se il prodotto non esiste più nel DB, non mandarlo nel JSON.
&nbsp;            // In questo modo evitiamo il NullPointerException.
<b class="fc">&nbsp;            if (p == null) {</b>
&nbsp;                continue; // Salta questo item e passa al prossimo
&nbsp;            }
&nbsp;            // --- FINE CORREZIONE ---
&nbsp;
<b class="fc">&nbsp;            JSONObject jsonObject = new JSONObject();</b>
&nbsp;            //crea l&#39;oggetto JSON con tutti i valori del prodotto
<b class="fc">&nbsp;            jsonObject.put(&quot;idProdotto&quot;, item.getIdProdotto());</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;idVariante&quot;, item.getIdVariante());</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;nomeProdotto&quot;, p.getNome()); // Ora &#39;p&#39; è sicuro</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;imgSrc&quot;, p.getImmagine());   // Ora &#39;p&#39; è sicuro</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;flavour&quot;, item.getGusto());</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;weight&quot;, item.getPesoConfezione());</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;quantity&quot;, item.getQuantita());</b>
&nbsp;
&nbsp;            //prezzo in base allo sconto che presenta il prodotto
<b class="fc">&nbsp;            float itemPrice = item.getPrezzo();</b>
<b class="fc">&nbsp;            itemPrice = Math.round(itemPrice * 100.0f) / 100.0f;</b>
<b class="fc">&nbsp;            jsonObject.put(&quot;prezzo&quot;, itemPrice);</b>
&nbsp;
&nbsp;            //prezzo totale del carrello
<b class="fc">&nbsp;            totalPrice += item.getPrezzo();</b>
&nbsp;
<b class="fc">&nbsp;            jsonArray.add(jsonObject);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        totalPrice = Math.round(totalPrice * 100.0f) / 100.0f;</b>
&nbsp;
<b class="fc">&nbsp;        JSONObject totalPriceObject = new JSONObject();</b>
<b class="fc">&nbsp;        totalPriceObject.put(&quot;totalPrice&quot;, totalPrice);</b>
<b class="fc">&nbsp;        jsonArray.add(totalPriceObject);</b>
&nbsp;
<b class="fc">&nbsp;        out.println(jsonArray);</b>
<b class="fc">&nbsp;        out.flush();</b>
&nbsp;        out.close();
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<b class="fc">&nbsp;        doGet(req, resp);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-17 10:45</div>
</div>
</body>
</html>
